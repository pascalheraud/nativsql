name: Pull Request Checks

on:
  pull_request:
    branches: [ main, develop ]

jobs:
  code-quality:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for better analysis

    - name: Set up Java
      uses: actions/setup-java@v5
      with:
        java-version: '22'
        distribution: 'temurin'
        cache: gradle

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Check code formatting
      run: ./gradlew spotlessCheck --no-daemon || true

    - name: Run linting
      run: ./gradlew lint --no-daemon || true

    - name: Build
      run: ./gradlew build --no-daemon

    - name: Check for security vulnerabilities
      run: ./gradlew dependencyCheck --no-daemon || true

  test-coverage:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Java
      uses: actions/setup-java@v5
      with:
        java-version: '22'
        distribution: 'temurin'
        cache: gradle

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Run tests with coverage
      run: ./gradlew test jacocoTestReport --no-daemon || true

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        files: ./build/reports/jacoco/test/jacocoTestReport.xml
        flags: unittests
        name: codecov-umbrella
